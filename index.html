<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Entrega de Materiais</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --cor1: #4A3F9E;
    --cor2: #6F63BD;
    --cor3: #A49BDC;
    --cor-bg: linear-gradient(135deg, #4A3F9E, #6F63BD);
    --text-color: white;
  }
  * { box-sizing: border-box; }
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 10px;
    background: var(--cor-bg);
    color: var(--text-color);
    min-height: 100vh;
  }
  h1 {
    text-align: center;
    margin: 10px 0;
  }
  .logo-text {
    font-size: 36px;
    font-weight: 900;
    color: white;
    font-family: 'Arial Black', Arial, sans-serif;
    text-align: center;
    margin: 0 auto 10px;
    max-width: 180px;
    letter-spacing: 4px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
    user-select: none;
  }
  .tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 15px;
  }
  .tabs button {
    background: var(--cor2);
    color: var(--text-color);
    font-weight: bold;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .tabs button.active {
    background: var(--cor3);
    color: #2e2a70;
  }
  .aba {
    display: none;
  }
  .aba.active {
    display: block;
  }
  label {
    display: block;
    margin: 8px 0 4px;
    font-weight: bold;
    color: black;
  }
  input[type="text"], input[type="number"] {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    background: white;
    color: black;
    font-size: 16px;
    border: 1px solid #ccc;
  }
  .linha {
    display: flex;
    gap: 5px;
    align-items: center;
    margin-top: 5px;
  }
  .linha input {
    flex: 1;
  }
  .linha button,
  .quantidade-control button,
  .btn-principal {
    background: var(--cor3);
    color: #2e2a70;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .quantidade-control {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 5px;
  }
  .quantidade-control button {
    width: 40px;
    height: 40px;
    font-size: 22px;
  }
  .btn-principal {
    padding: 14px;
    font-weight: bold;
    width: 100%;
    margin-top: 12px;
    font-size: 16px;
  }
  .btn-principal:hover,
  .linha button:hover,
  .quantidade-control button:hover {
    background: #8f87d1;
  }
  .carrinho {
    margin-top: 15px;
    border-top: 1px solid rgba(0,0,0,0.1);
    padding-top: 10px;
    max-height: 250px;
    overflow-y: auto;
    color: black;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 8px;
  }
  .carrinho-item {
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    color: black;
    position: relative;
    background: #d4d3f9;
  }
  .acoes {
    position: absolute;
    right: 10px;
    top: 10px;
    display: flex;
    gap: 5px;
  }
  .acoes button {
    padding: 5px 10px;
    border-radius: 6px;
    color: white;
  }
  .acoes .excluir {
    background-color: #f44336;
  }
  .acoes .excluir:hover {
    background-color: #b9302a;
  }
  .acoes button:not(.excluir) {
    background-color: #4a54f1;
  }
  .acoes button:not(.excluir):hover {
    background-color: #2c32b7;
  }
  #leitor-camera, #leitor-camera-transferencia {
    display: none;
    margin-top: 10px;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
  }
  .fechar-camera-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 0, 0, 0.8);
    border: none;
    color: white;
    font-size: 18px;
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 6px;
    cursor: pointer;
    z-index: 10;
  }
  /* Aumentar √≠cone do bot√£o scanner */
  .linha button {
    font-size: 26px;
    width: 48px;
    height: 48px;
    line-height: 44px;
    padding: 0;
    text-align: center;
  }
</style>
</head>
<body>
  <div class="logo-text">Cremer</div>
  <h1>Entrega de Materiais</h1>

  <div class="tabs">
    <button id="btn-uso" class="active" onclick="mostrarAba('uso')">Uso Consumo</button>
    <button id="btn-transferencia" onclick="mostrarAba('transferencia')">Transfer√™ncia</button>
  </div>

  <!-- ABA USO CONSUMO -->
  <div id="aba-uso" class="aba active">
    <label>Transa√ß√£o:</label>
    <input type="text" id="transacao" maxlength="3" />
    <label>Centro de Custo:</label>
    <input type="text" id="centro" maxlength="6" />
    <label>Solicitante:</label>
    <input type="text" id="solicitante" />
    <label>Respons√°vel:</label>
    <input type="text" id="responsavel" />
    <label>C√≥digo:</label>
    <div class="linha">
      <input type="text" id="codigo" autocomplete="off" />
      <button onclick="iniciarScanner('codigo', 'leitor-camera')">üì∑</button>
    </div>
    <div id="leitor-camera"></div>
    <label>Descri√ß√£o:</label>
    <input type="text" id="descricao" readonly />
    <label>Quantidade:</label>
    <div class="quantidade-control">
      <button onclick="alterarQtd('quantidade', -1)">‚àí</button>
      <input type="number" id="quantidade" value="1" min="1" />
      <button onclick="alterarQtd('quantidade', 1)">+</button>
    </div>
    <button class="btn-principal" onclick="adicionarItemUso()">Adicionar ao Carrinho</button>
    <div class="carrinho" id="carrinhoUso"><p>Nenhum item no carrinho.</p></div>
    <button class="btn-principal" onclick="finalizarEntregaUso()">Finalizar Entrega (Exportar XLSX)</button>
  </div>

  <!-- ABA TRANSFER√äNCIA -->
  <div id="aba-transferencia" class="aba">
    <label>Armaz√©m de Origem:</label>
    <input type="text" id="origemTransf" />
    <label>Armaz√©m de Destino:</label>
    <input type="text" id="destinoTransf" />
    <label>Solicitante:</label>
    <input type="text" id="solicitanteTransf" />
    <label>Respons√°vel:</label>
    <input type="text" id="responsavelTransf" />
    <label>C√≥digo:</label>
    <div class="linha">
      <input type="text" id="codigoTransf" autocomplete="off" />
      <button onclick="iniciarScanner('codigoTransf', 'leitor-camera-transferencia')">üì∑</button>
    </div>
    <div id="leitor-camera-transferencia"></div>
    <label>Descri√ß√£o:</label>
    <input type="text" id="descricaoTransf" readonly />
    <label>Quantidade:</label>
    <div class="quantidade-control">
      <button onclick="alterarQtd('quantidadeTransf', -1)">‚àí</button>
      <input type="number" id="quantidadeTransf" value="1" min="1" />
      <button onclick="alterarQtd('quantidadeTransf', 1)">+</button>
    </div>
    <button class="btn-principal" onclick="adicionarItemTransf()">Adicionar ao Carrinho</button>
    <div class="carrinho" id="carrinhoTransf"><p>Nenhum item no carrinho.</p></div>
    <button class="btn-principal" onclick="finalizarEntregaTransf()">Finalizar Transfer√™ncia (Exportar XLSX)</button>
  </div>

<script>
  const URL_BUSCA_DESCRICAO = "https://script.google.com/macros/s/AKfycbzrUd51_l3if4GdFaVHYtxvYfznpHH5TN16GgB9yFZHQwNYOE30QKJTuawEtQa914hm/exec";

  let carrinhoUso = [];
  let carrinhoTransf = [];

  function mostrarAba(aba) {
    document.querySelectorAll(".aba").forEach(el => el.classList.remove("active"));
    document.querySelectorAll(".tabs button").forEach(el => el.classList.remove("active"));
    document.getElementById("aba-" + aba).classList.add("active");
    document.getElementById("btn-" + aba).classList.add("active");
    fecharScanner("leitor-camera");
    fecharScanner("leitor-camera-transferencia");
  }

  function alterarQtd(id, val) {
    const input = document.getElementById(id);
    let n = parseInt(input.value) || 1;
    n += val;
    if (n < 1) n = 1;
    input.value = n;
  }

  // Busca descri√ß√£o autom√°tica para os dois c√≥digos
  async function buscarDescricao(idCodigo, idDesc) {
    const codigo = document.getElementById(idCodigo).value.trim();
    if (!codigo) {
      document.getElementById(idDesc).value = "";
      return;
    }
    document.getElementById(idDesc).value = "Buscando...";
    try {
      const res = await fetch(`${URL_BUSCA_DESCRICAO}?codigo=${encodeURIComponent(codigo)}`);
      const json = await res.json();
      document.getElementById(idDesc).value = json.descricao || "N√£o encontrado";
    } catch {
      document.getElementById(idDesc).value = "Erro";
    }
  }

  // Quando digitar ou sair do campo c√≥digo, dispara busca da descri√ß√£o
  document.getElementById("codigo").addEventListener("input", () => buscarDescricao("codigo", "descricao"));
  document.getElementById("codigoTransf").addEventListener("input", () => buscarDescricao("codigoTransf", "descricaoTransf"));

  function getVal(id) {
    return document.getElementById(id)?.value?.trim();
  }

  // --- Uso Consumo ---
  function adicionarItemUso() {
    const item = {
      codigo: getVal("codigo"),
      descricao: getVal("descricao"),
      quantidade: getVal("quantidade"),
      transacao: getVal("transacao"),
      centro: getVal("centro"),
      solicitante: getVal("solicitante"),
      responsavel: getVal("responsavel")
    };

    if (Object.values(item).some(v => !v || v === "N√£o encontrado" || v === "Erro")) {
      alert("Preencha todos os campos corretamente.");
      return;
    }

    carrinhoUso.push(item);
    renderCarrinhoUso();
    limparCamposUso();
  }

  function limparCamposUso() {
    ["codigo", "descricao", "quantidade"].forEach(id => {
      document.getElementById(id).value = (id === "quantidade") ? 1 : "";
    });
  }

  function renderCarrinhoUso() {
    const div = document.getElementById("carrinhoUso");
    if (carrinhoUso.length === 0) {
      div.innerHTML = "<p>Nenhum item no carrinho.</p>";
      return;
    }
    div.innerHTML = "<h3>Itens:</h3>";
    carrinhoUso.forEach((item, i) => {
      div.innerHTML += `
        <div class="carrinho-item">
          <div><b>${item.codigo}</b> - ${item.descricao} (${item.quantidade})</div>
          <small>${item.transacao} | ${item.centro} | ${item.solicitante} | ${item.responsavel}</small>
          <div class="acoes">
            <button onclick="editarItemUso(${i})">Editar</button>
            <button class="excluir" onclick="excluirItemUso(${i})">Excluir</button>
          </div>
        </div>
      `;
    });
  }

  function editarItemUso(i) {
    const item = carrinhoUso[i];
    mostrarAba("uso");
    Object.entries(item).forEach(([chave, valor]) => {
      if (document.getElementById(chave)) {
        document.getElementById(chave).value = valor;
      }
    });
    carrinhoUso.splice(i, 1);
    renderCarrinhoUso();
  }

  function excluirItemUso(i) {
    carrinhoUso.splice(i, 1);
    renderCarrinhoUso();
  }

  // --- Transfer√™ncia ---
  function adicionarItemTransf() {
    const item = {
      codigo: getVal("codigoTransf"),
      descricao: getVal("descricaoTransf"),
      quantidade: getVal("quantidadeTransf"),
      origem: getVal("origemTransf"),
      destino: getVal("destinoTransf"),
      solicitante: getVal("solicitanteTransf"),
      responsavel: getVal("responsavelTransf")
    };

    if (Object.values(item).some(v => !v || v === "N√£o encontrado" || v === "Erro")) {
      alert("Preencha todos os campos corretamente.");
      return;
    }

    carrinhoTransf.push(item);
    renderCarrinhoTransf();
    limparCamposTransf();
  }

  function limparCamposTransf() {
    ["codigoTransf", "descricaoTransf", "quantidadeTransf"].forEach(id => {
      document.getElementById(id).value = (id === "quantidadeTransf") ? 1 : "";
    });
  }

  function renderCarrinhoTransf() {
    const div = document.getElementById("carrinhoTransf");
    if (carrinhoTransf.length === 0) {
      div.innerHTML = "<p>Nenhum item no carrinho.</p>";
      return;
    }
    div.innerHTML = "<h3>Itens:</h3>";
    carrinhoTransf.forEach((item, i) => {
      div.innerHTML += `
        <div class="carrinho-item">
          <div><b>${item.codigo}</b> - ${item.descricao} (${item.quantidade})</div>
          <small>${item.origem} ‚Üí ${item.destino} | ${item.solicitante} | ${item.responsavel}</small>
          <div class="acoes">
            <button onclick="editarItemTransf(${i})">Editar</button>
            <button class="excluir" onclick="excluirItemTransf(${i})">Excluir</button>
          </div>
        </div>
      `;
    });
  }

  function editarItemTransf(i) {
    const item = carrinhoTransf[i];
    mostrarAba("transferencia");
    Object.entries(item).forEach(([chave, valor]) => {
      if (document.getElementById(chave)) {
        document.getElementById(chave).value = valor;
      }
    });
    carrinhoTransf.splice(i, 1);
    renderCarrinhoTransf();
  }

  function excluirItemTransf(i) {
    carrinhoTransf.splice(i, 1);
    renderCarrinhoTransf();
  }

  // Fun√ß√£o para exportar e baixar XLSX separado
  function exportarXLSX(titulo, dados, colunas, nomeArquivo) {
    // Cria uma matriz de arrays para SheetJS
    const ws_data = [colunas];
    dados.forEach(item => {
      const row = colunas.map(col => item[col.toLowerCase()] || item[col.toLowerCase().replace(/ /g, '')] || "");
      ws_data.push(row);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, titulo);
    XLSX.writeFile(wb, nomeArquivo);
  }

  // Finalizar Uso Consumo - valida e exporta XLSX
  function finalizarEntregaUso() {
    if (carrinhoUso.length === 0) {
      alert("Adicione ao menos um item no carrinho Uso Consumo antes de finalizar.");
      return;
    }

    // Validar campos fixos do uso consumo
    const transacao = getVal("transacao");
    const centro = getVal("centro");
    const solicitante = getVal("solicitante");
    const responsavel = getVal("responsavel");
    if (!transacao || !centro || !solicitante || !responsavel) {
      alert("Preencha os campos Transa√ß√£o, Centro de Custo, Solicitante e Respons√°vel.");
      return;
    }

    // Exporta XLSX com aba √∫nica para uso consumo
    const colunas = ["C√≥digo", "Descri√ß√£o", "Quantidade", "Transa√ß√£o", "Centro", "Solicitante", "Respons√°vel"];
    exportarXLSX(
      "Uso Consumo",
      carrinhoUso.map(i => ({
        c√≥digo: i.codigo,
        descri√ß√£o: i.descricao,
        quantidade: i.quantidade,
        transa√ß√£o: i.transacao,
        centro: i.centro,
        solicitante: i.solicitante,
        respons√°vel: i.responsavel
      })),
      colunas,
      `uso_consumo_${Date.now()}.xlsx`
    );

    // Limpa carrinho e campos
    carrinhoUso = [];
    renderCarrinhoUso();
    ["transacao","centro","solicitante","responsavel"].forEach(id => document.getElementById(id).value = "");
  }

  // Finalizar Transfer√™ncia - valida e exporta XLSX
  function finalizarEntregaTransf() {
    if (carrinhoTransf.length === 0) {
      alert("Adicione ao menos um item no carrinho Transfer√™ncia antes de finalizar.");
      return;
    }

    // Validar campos fixos transfer√™ncia
    const origem = getVal("origemTransf");
    const destino = getVal("destinoTransf");
    const solicitante = getVal("solicitanteTransf");
    const responsavel = getVal("responsavelTransf");
    if (!origem || !destino || !solicitante || !responsavel) {
      alert("Preencha os campos Armaz√©m de Origem, Armaz√©m de Destino, Solicitante e Respons√°vel.");
      return;
    }

    const colunas = ["C√≥digo", "Descri√ß√£o", "Quantidade", "Origem", "Destino", "Solicitante", "Respons√°vel"];
    exportarXLSX(
      "Transfer√™ncia",
      carrinhoTransf.map(i => ({
        c√≥digo: i.codigo,
        descri√ß√£o: i.descricao,
        quantidade: i.quantidade,
        origem: i.origem,
        destino: i.destino,
        solicitante: i.solicitante,
        respons√°vel: i.responsavel
      })),
      colunas,
      `transferencia_${Date.now()}.xlsx`
    );

    // Limpa carrinho e campos
    carrinhoTransf = [];
    renderCarrinhoTransf();
    ["origemTransf","destinoTransf","solicitanteTransf","responsavelTransf"].forEach(id => document.getElementById(id).value = "");
  }

  // Scanner - vari√°vel global para poder parar e recome√ßar
  let scanner = null;

  // Iniciar scanner - idInput: campo do c√≥digo, idLeitor: div do leitor
  function iniciarScanner(idInput, idLeitor) {
    const divLeitor = document.getElementById(idLeitor);
    if (scanner) {
      scanner.clear().catch(console.error);
      scanner = null;
      divLeitor.style.display = "none";
      return;
    }
    divLeitor.style.display = "block";
    divLeitor.innerHTML = `<button class="fechar-camera-btn" onclick="fecharScanner('${idLeitor}')">‚úñ</button>`;
    scanner = new Html5Qrcode(idLeitor);
    const config = { fps: 10, qrbox: 250, aspectRatio: 1.2 };

    scanner.start(
      { facingMode: "environment" },
      config,
      qrCodeMessage => {
        document.getElementById(idInput).value = qrCodeMessage;
        if (idInput === "codigo") buscarDescricao("codigo", "descricao");
        else if (idInput === "codigoTransf") buscarDescricao("codigoTransf", "descricaoTransf");
        fecharScanner(idLeitor);
      },
      errorMessage => {
        // Ignorar erros pequenos de leitura
      }
    ).catch(err => {
      alert("Erro ao iniciar c√¢mera: " + err);
      fecharScanner(idLeitor);
    });
  }

  function fecharScanner(idLeitor) {
    if (scanner) {
      scanner.stop().then(() => {
        scanner.clear();
        scanner = null;
      }).catch(console.error);
    }
    const divLeitor = document.getElementById(idLeitor);
    divLeitor.style.display = "none";
    divLeitor.innerHTML = "";
  }

  // Inicializa carrinhos vazios
  renderCarrinhoUso();
  renderCarrinhoTransf();
</script>
</body>
</html>
