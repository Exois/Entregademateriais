<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Entrega de Materiais</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  :root {
    --cor1: #A172EA;
    --cor2: #D09AF4;
    --cor3: #FFC1FF;
    --cor-bg: linear-gradient(135deg, #724BDF, #D09AF4);
    --text-color: white;
  }
  * { box-sizing: border-box; }
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 20px;
    background: var(--cor-bg);
    color: var(--text-color);
  }
  h1 {
    text-align: center;
    margin-bottom: 20px;
  }
  .tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
  }
  .tabs button {
    background: var(--cor2);
    color: var(--text-color);
    font-weight: bold;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  .tabs button.active {
    background: var(--cor3);
    color: #8A2BE2;
  }
  .aba {
    display: none;
  }
  .aba.active {
    display: block;
  }
  label {
    display: block;
    margin: 10px 0 5px;
    font-weight: bold;
  }
  input[type="text"], input[type="number"] {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 8px;
    background: var(--cor1);
    color: var(--text-color);
    font-size: 16px;
  }
  .linha {
    display: flex;
    gap: 5px;
    align-items: center;
  }
  .linha input {
    flex: 1;
  }
  .linha button {
    padding: 10px;
    background: var(--cor3);
    color: #8A2BE2;
    font-size: 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  .quantidade-control {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 5px;
  }
  .quantidade-control button {
    background: var(--cor3);
    color: #8A2BE2;
    border: none;
    border-radius: 8px;
    width: 40px;
    height: 40px;
    font-size: 20px;
    cursor: pointer;
  }
  .btn-principal {
    background: var(--cor3);
    color: #8A2BE2;
    padding: 12px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    width: 100%;
    margin-top: 10px;
    cursor: pointer;
  }
  #leitor-camera, #leitor-camera-transferencia {
    display: none;
    margin-top: 10px;
  }
  .btn-fechar {
    margin-top: 5px;
    background: transparent;
    border: 1px solid #fff;
    color: white;
    padding: 5px 10px;
    border-radius: 8px;
    cursor: pointer;
  }
  .carrinho {
    margin-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.3);
    padding-top: 10px;
  }
  .carrinho-item {
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.3);
    margin-bottom: 8px;
    position: relative;
  }
  .acoes {
    position: absolute;
    right: 10px;
    top: 10px;
    display: flex;
    gap: 5px;
  }
  .acoes button {
    background-color: #2196f3;
    color: white;
    padding: 5px 10px;
    font-size: 14px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .acoes button.excluir {
    background-color: #f44336;
  }
</style>
</head>
<body>

<h1>Entrega de Materiais</h1>

<div class="tabs">
  <button id="btn-uso" class="active" onclick="mostrarAba('uso')">Uso Consumo</button>
  <button id="btn-transferencia" onclick="mostrarAba('transferencia')">Transfer√™ncia</button>
</div>

<!-- ABA USO CONSUMO -->
<div id="aba-uso" class="aba active">
  <label>Transa√ß√£o (3 caracteres):</label>
  <input type="text" id="transacao" maxlength="3" />

  <label>Centro de Custo (6 caracteres):</label>
  <input type="text" id="centro" maxlength="6" />

  <label>Solicitante:</label>
  <input type="text" id="solicitante" />

  <label>Respons√°vel pelo Atendimento:</label>
  <input type="text" id="responsavel" />

  <label>C√≥digo de barras ou manual:</label>
  <div class="linha">
    <input type="text" id="codigo" autocomplete="off" />
    <button onclick="iniciarScanner('leitor-camera', 'codigo')">üì∑</button>
  </div>
  <div id="leitor-camera"></div>
  <button class="btn-fechar" onclick="fecharCamera('leitor-camera')">Fechar C√¢mera</button>

  <label>Descri√ß√£o:</label>
  <input type="text" id="descricao" readonly />

  <label>Quantidade:</label>
  <div class="quantidade-control">
    <button onclick="alterarQuantidade('quantidade', -1)">‚àí</button>
    <input type="number" id="quantidade" value="1" min="1" />
    <button onclick="alterarQuantidade('quantidade', 1)">+</button>
  </div>

  <button id="btn-adicionar-uso" class="btn-principal" onclick="adicionarItem('uso')">Adicionar ao carrinho</button>
  <button id="btn-atualizar-uso" class="btn-principal" style="display:none;" onclick="atualizarItem('uso')">Atualizar Item</button>

  <div class="carrinho" id="carrinho-uso">
    <h3>Itens adicionados:</h3>
  </div>

  <button class="btn-principal" onclick="finalizarEntrega()">Finalizar Entrega</button>
</div>

<!-- ABA TRANSFER√äNCIA -->
<div id="aba-transferencia" class="aba">
  <label>Armaz√©m de Origem:</label>
  <input type="text" id="origem" />

  <label>Armaz√©m de Destino:</label>
  <input type="text" id="destino" />

  <label>Solicitante:</label>
  <input type="text" id="solicitanteTransf" />

  <label>Respons√°vel pelo Atendimento:</label>
  <input type="text" id="responsavelTransf" />

  <label>C√≥digo de barras ou manual:</label>
  <div class="linha">
    <input type="text" id="codigoTransf" autocomplete="off" />
    <button onclick="iniciarScanner('leitor-camera-transferencia', 'codigoTransf')">üì∑</button>
  </div>
  <div id="leitor-camera-transferencia"></div>
  <button class="btn-fechar" onclick="fecharCamera('leitor-camera-transferencia')">Fechar C√¢mera</button>

  <label>Descri√ß√£o:</label>
  <input type="text" id="descricaoTransf" readonly />

  <label>Quantidade:</label>
  <div class="quantidade-control">
    <button onclick="alterarQuantidade('quantidadeTransf', -1)">‚àí</button>
    <input type="number" id="quantidadeTransf" value="1" min="1" />
    <button onclick="alterarQuantidade('quantidadeTransf', 1)">+</button>
  </div>

  <button id="btn-adicionar-transf" class="btn-principal" onclick="adicionarItem('transf')">Adicionar ao carrinho</button>
  <button id="btn-atualizar-transf" class="btn-principal" style="display:none;" onclick="atualizarItem('transf')">Atualizar Item</button>

  <div class="carrinho" id="carrinho-transf">
    <h3>Itens adicionados:</h3>
  </div>

  <button class="btn-principal" onclick="registrarTransferencia()">Registrar Transfer√™ncia</button>
</div>

<script>
  let scannerAtivo = null;

  // Carrinhos separados
  let carrinhoUso = [];
  let carrinhoTransf = [];

  // √çndices para edi√ß√£o (um por aba)
  let indiceEditandoUso = -1;
  let indiceEditandoTransf = -1;

  function mostrarAba(qual) {
    document.querySelectorAll('.aba').forEach(a => a.classList.remove('active'));
    document.querySelector('#aba-' + qual).classList.add('active');
    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    document.querySelector('#btn-' + qual).classList.add('active');
    fecharCamera('leitor-camera');
    fecharCamera('leitor-camera-transferencia');
  }

  function alterarQuantidade(id, val) {
    const campo = document.getElementById(id);
    let qtd = parseInt(campo.value) || 1;
    campo.value = Math.max(1, qtd + val);
  }

  function iniciarScanner(divId, inputId) {
    const div = document.getElementById(divId);
    div.style.display = "block";

    if(scannerAtivo){
      scannerAtivo.stop().then(() => {
        scannerAtivo.clear();
        startScanner();
      }).catch(() => {
        startScanner();
      });
    } else {
      startScanner();
    }

    function startScanner(){
      scannerAtivo = new Html5Qrcode(divId);
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras.length) {
          const traseira = cameras.find(cam =>
            cam.label.toLowerCase().includes("back") ||
            cam.label.toLowerCase().includes("traseira")
          );
          const camId = traseira ? traseira.id : cameras[0].id;

          scannerAtivo.start(
            camId,
            { fps: 10, qrbox: { width: 250, height: 100 } },
            (codigoLido) => {
              document.getElementById(inputId).value = codigoLido;
              fecharCamera(divId);
            }
          ).catch(() => {
            alert("Erro ao acessar a c√¢mera");
          });
        } else {
          alert("Nenhuma c√¢mera dispon√≠vel");
        }
      });
    }
  }

  function fecharCamera(divId) {
    if (scannerAtivo) {
      scannerAtivo.stop().then(() => {
        scannerAtivo.clear();
        scannerAtivo = null;
        const div = document.getElementById(divId);
        div.innerHTML = "";
        div.style.display = "none";
      }).catch(() => {
        const div = document.getElementById(divId);
        div.innerHTML = "";
        div.style.display = "none";
      });
    }
  }

  // Fun√ß√£o para adicionar item ao carrinho das abas uso ou transf
  function adicionarItem(aba) {
    if (aba === 'uso') {
      const codigo = document.getElementById("codigo").value.trim();
      const descricao = document.getElementById("descricao").value.trim();
      const quantidade = parseInt(document.getElementById("quantidade").value);
      const transacao = document.getElementById("transacao").value.trim();
      const centro = document.getElementById("centro").value.trim();
      const solicitante = document.getElementById("solicitante").value.trim();
      const responsavel = document.getElementById("responsavel").value.trim();

      if (!codigo) { alert("Informe o c√≥digo do material."); return; }
      if (quantidade < 1 || isNaN(quantidade)) { alert("Quantidade inv√°lida."); return; }

      carrinhoUso.push({codigo, descricao, quantidade, transacao, centro, solicitante, responsavel});
      indiceEditandoUso = -1;
      limparCamposUso();
      renderizarCarrinho('uso');
      toggleBotoes('uso', false);
    }
    else if (aba === 'transf') {
      const origem = document.getElementById("origem").value.trim();
      const destino = document.getElementById("destino").value.trim();
      const codigo = document.getElementById("codigoTransf").value.trim();
      const descricao = document.getElementById("descricaoTransf").value.trim();
      const quantidade = parseInt(document.getElementById("quantidadeTransf").value);
      const solicitante = document.getElementById("solicitanteTransf").value.trim();
      const responsavel = document.getElementById("responsavelTransf").value.trim();

      if (!origem || !destino) { alert("Informe origem e destino."); return; }
      if (!codigo) { alert("Informe o c√≥digo do material."); return; }
      if (quantidade < 1 || isNaN(quantidade)) { alert("Quantidade inv√°lida."); return; }

      carrinhoTransf.push({origem, destino, codigo, descricao, quantidade, solicitante, responsavel});
      indiceEditandoTransf = -1;
      limparCamposTransf();
      renderizarCarrinho('transf');
      toggleBotoes('transf', false);
    }
  }

  // Fun√ß√£o para renderizar carrinho
  function renderizarCarrinho(aba) {
    let carrinhoArray, div;
    if (aba === 'uso') {
      carrinhoArray = carrinhoUso;
      div = document.getElementById("carrinho-uso");
    } else {
      carrinhoArray = carrinhoTransf;
      div = document.getElementById("carrinho-transf");
    }
    div.innerHTML = "<h3>Itens adicionados:</h3>";

    if (carrinhoArray.length === 0) {
      div.innerHTML += "<p>Nenhum item adicionado.</p>";
      return;
    }

    carrinhoArray.forEach((item, i) => {
      let infoHtml = "";
      if(aba === 'uso'){
        infoHtml = `
          <div><strong>${item.codigo}</strong> - ${item.descricao} (Qtd: ${item.quantidade})</div>
          <div><small>Transa√ß√£o: ${item.transacao} | Centro: ${item.centro} | Solicitante: ${item.solicitante} | Respons√°vel: ${item.responsavel}</small></div>
        `;
      } else {
        infoHtml = `
          <div><strong>${item.codigo}</strong> - ${item.descricao} (Qtd: ${item.quantidade})</div>
          <div><small>Origem: ${item.origem} | Destino: ${item.destino} | Solicitante: ${item.solicitante} | Respons√°vel: ${item.responsavel}</small></div>
        `;
      }

      const el = document.createElement("div");
      el.className = "carrinho-item";
      el.innerHTML = infoHtml;

      const acoesDiv = document.createElement("div");
      acoesDiv.className = "acoes";

      const btnEditar = document.createElement("button");
      btnEditar.textContent = "Editar";
      btnEditar.onclick = () => editarItem(aba, i);

      const btnExcluir = document.createElement("button");
      btnExcluir.textContent = "Excluir";
      btnExcluir.className = "excluir";
      btnExcluir.onclick = () => excluirItem(aba, i);

      acoesDiv.appendChild(btnEditar);
      acoesDiv.appendChild(btnExcluir);
      el.appendChild(acoesDiv);
      div.appendChild(el);
    });
  }

  // Fun√ß√£o para editar item do carrinho
  function editarItem(aba, indice) {
    if (aba === 'uso') {
      const item = carrinhoUso[indice];
      document.getElementById("codigo").value = item.codigo;
      document.getElementById("descricao").value = item.descricao;
      document.getElementById("quantidade").value = item.quantidade;
      document.getElementById("transacao").value = item.transacao;
      document.getElementById("centro").value = item.centro;
      document.getElementById("solicitante").value = item.solicitante;
      document.getElementById("responsavel").value = item.responsavel;

      indiceEditandoUso = indice;
      toggleBotoes('uso', true);
    } else {
      const item = carrinhoTransf[indice];
      document.getElementById("origem").value = item.origem;
      document.getElementById("destino").value = item.destino;
      document.getElementById("codigoTransf").value = item.codigo;
      document.getElementById("descricaoTransf").value = item.descricao;
      document.getElementById("quantidadeTransf").value = item.quantidade;
      document.getElementById("solicitanteTransf").value = item.solicitante;
      document.getElementById("responsavelTransf").value = item.responsavel;

      indiceEditandoTransf = indice;
      toggleBotoes('transf', true);
    }
  }

  // Fun√ß√£o para excluir item do carrinho
  function excluirItem(aba, indice) {
    if (aba === 'uso') {
      carrinhoUso.splice(indice, 1);
      if (indiceEditandoUso === indice) {
        limparCamposUso();
        toggleBotoes('uso', false);
        indiceEditandoUso = -1;
      }
      renderizarCarrinho('uso');
    } else {
      carrinhoTransf.splice(indice, 1);
      if (indiceEditandoTransf === indice) {
        limparCamposTransf();
        toggleBotoes('transf', false);
        indiceEditandoTransf = -1;
      }
      renderizarCarrinho('transf');
    }
  }

  // Fun√ß√£o para atualizar item editado
  function atualizarItem(aba) {
    if (aba === 'uso') {
      if (indiceEditandoUso < 0) return;
      const codigo = document.getElementById("codigo").value.trim();
      const descricao = document.getElementById("descricao").value.trim();
      const quantidade = parseInt(document.getElementById("quantidade").value);
      const transacao = document.getElementById("transacao").value.trim();
      const centro = document.getElementById("centro").value.trim();
      const solicitante = document.getElementById("solicitante").value.trim();
      const responsavel = document.getElementById("responsavel").value.trim();

      if (!codigo) { alert("Informe o c√≥digo do material."); return; }
      if (quantidade < 1 || isNaN(quantidade)) { alert("Quantidade inv√°lida."); return; }

      carrinhoUso[indiceEditandoUso] = {codigo, descricao, quantidade, transacao, centro, solicitante, responsavel};
      indiceEditandoUso = -1;
      limparCamposUso();
      renderizarCarrinho('uso');
      toggleBotoes('uso', false);
    } else {
      if (indiceEditandoTransf < 0) return;
      const origem = document.getElementById("origem").value.trim();
      const destino = document.getElementById("destino").value.trim();
      const codigo = document.getElementById("codigoTransf").value.trim();
      const descricao = document.getElementById("descricaoTransf").value.trim();
      const quantidade = parseInt(document.getElementById("quantidadeTransf").value);
      const solicitante = document.getElementById("solicitanteTransf").value.trim();
      const responsavel = document.getElementById("responsavelTransf").value.trim();

      if (!origem || !destino) { alert("Informe origem e destino."); return; }
      if (!codigo) { alert("Informe o c√≥digo do material."); return; }
      if (quantidade < 1 || isNaN(quantidade)) { alert("Quantidade inv√°lida."); return; }

      carrinhoTransf[indiceEditandoTransf] = {origem, destino, codigo, descricao, quantidade, solicitante, responsavel};
      indiceEditandoTransf = -1;
      limparCamposTransf();
      renderizarCarrinho('transf');
      toggleBotoes('transf', false);
    }
  }

  // Limpar campos aba uso
  function limparCamposUso() {
    document.getElementById("codigo").value = "";
    document.getElementById("descricao").value = "";
    document.getElementById("quantidade").value = 1;
    document.getElementById("transacao").value = "";
    document.getElementById("centro").value = "";
    document.getElementById("solicitante").value = "";
    document.getElementById("responsavel").value = "";
  }

  // Limpar campos aba transfer√™ncia
  function limparCamposTransf() {
    document.getElementById("origem").value = "";
    document.getElementById("destino").value = "";
    document.getElementById("codigoTransf").value = "";
    document.getElementById("descricaoTransf").value = "";
    document.getElementById("quantidadeTransf").value = 1;
    document.getElementById("solicitanteTransf").value = "";
    document.getElementById("responsavelTransf").value = "";
  }

  // Mostra ou esconde bot√µes adicionar/atualizar conforme edi√ß√£o
  function toggleBotoes(aba, editando) {
    if (aba === 'uso') {
      document.getElementById("btn-adicionar-uso").style.display = editando ? "none" : "block";
      document.getElementById("btn-atualizar-uso").style.display = editando ? "block" : "none";
    } else {
      document.getElementById("btn-adicionar-transf").style.display = editando ? "none" : "block";
      document.getElementById("btn-atualizar-transf").style.display = editando ? "block" : "none";
    }
  }

  // Finalizar entrega (Uso Consumo)
  function finalizarEntrega() {
    if (carrinhoUso.length === 0) {
      alert("Adicione pelo menos um item no carrinho.");
      return;
    }
    alert("Entrega finalizada com sucesso!");
    carrinhoUso = [];
    renderizarCarrinho('uso');
    limparCamposUso();
    toggleBotoes('uso', false);
  }

  // Registrar transfer√™ncia (Transfer√™ncia)
  function registrarTransferencia() {
    if (carrinhoTransf.length === 0) {
      alert("Adicione pelo menos um item no carrinho.");
      return;
    }
    alert("Transfer√™ncia registrada com sucesso!");
    carrinhoTransf = [];
    renderizarCarrinho('transf');
    limparCamposTransf();
    toggleBotoes('transf', false);
  }

  // Renderiza ao abrir para garantir visualiza√ß√£o correta
  renderizarCarrinho('uso');
  renderizarCarrinho('transf');
</script>
</body>
</html>
