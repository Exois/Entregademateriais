<!-- ... mantive seu HTML igual, exceto a parte final -->

<!-- Campos finais -->
<div class="finalizar" id="finalizar" style="display:none;">
  <label>Transação (3 caracteres):</label>
  <input type="text" maxlength="3" id="inputTransacao">

  <label>Centro de Custo (6 caracteres):</label>
  <input type="text" maxlength="6" id="inputCentroCusto">

  <label>Solicitante:</label>
  <input type="text" id="inputSolicitante">

  <label>Responsável pelo Atendimento:</label>
  <input type="text" id="inputResponsavel">

  <button class="btn-principal" id="finalizarBtn">Finalizar Entrega</button>
</div>

<button class="btn-principal" id="editarUltimoBtn" style="display:none; margin-top:10px;">Editar Último Item</button>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzrUd51_l3if4GdFaVHYtxvYfznpHH5TN16GgB9yFZHQwNYOE30QKJTuawEtQa914hm/exec";

  let carrinho = [];
  let editandoIndex = -1;

  function alterarQuantidade(valor) {
    const campo = document.getElementById("quantidade");
    let atual = parseInt(campo.value) || 1;
    atual = Math.max(1, atual + valor);
    campo.value = atual;
  }

  async function buscarDescricao() {
    const codigo = document.getElementById("codigo").value.trim();
    if (!codigo) return;

    try {
      const res = await fetch(`${API_URL}?codigo=${codigo}`);
      const json = await res.json();
      if (json.descricao) {
        document.getElementById("descricao").value = json.descricao;
      } else {
        document.getElementById("descricao").value = "Produto não encontrado";
      }
    } catch (e) {
      document.getElementById("descricao").value = "Erro na busca";
    }
  }

  function renderizarCarrinho() {
    const carrinhoDiv = document.getElementById("carrinho");
    carrinhoDiv.innerHTML = "<h3>Itens adicionados:</h3>";
    carrinho.forEach((item, i) => {
      const div = document.createElement("div");
      div.className = "carrinho-item";
      div.innerText = `Código: ${item.codigo} | Descrição: ${item.descricao} | Quantidade: ${item.quantidade}`;
      carrinhoDiv.appendChild(div);
    });

    // Mostrar botão editar se tiver itens
    document.getElementById("editarUltimoBtn").style.display = carrinho.length > 0 ? "block" : "none";
  }

  function adicionarItem() {
    const codigo = document.getElementById("codigo").value.trim();
    const descricao = document.getElementById("descricao").value.trim();
    const quantidade = parseInt(document.getElementById("quantidade").value);

    if (!codigo || !descricao || !quantidade || descricao === "Produto não encontrado") {
      alert("Preencha um código válido e aguarde a descrição.");
      return;
    }

    if (editandoIndex >= 0) {
      // Editando item existente
      carrinho[editandoIndex] = { codigo, descricao, quantidade };
      editandoIndex = -1;
    } else {
      // Adicionando novo item
      carrinho.push({ codigo, descricao, quantidade });
    }

    renderizarCarrinho();

    // Mostrar campos finais
    const finalizarDiv = document.getElementById("finalizar");
    finalizarDiv.style.display = "block";

    // Se for primeira vez preenchendo os campos fixos, deixa editável, senão bloqueia
    bloquearCamposFixos();

    // Limpar campos para novo item
    limparCamposItem();
  }

  function limparCamposItem() {
    document.getElementById("codigo").value = "";
    document.getElementById("descricao").value = "";
    document.getElementById("quantidade").value = 1;
  }

  // Função para abrir edição do último item
  document.getElementById("editarUltimoBtn").addEventListener("click", () => {
    if (carrinho.length === 0) return;
    editandoIndex = carrinho.length - 1;
    const item = carrinho[editandoIndex];
    document.getElementById("codigo").value = item.codigo;
    document.getElementById("descricao").value = item.descricao;
    document.getElementById("quantidade").value = item.quantidade;

    // Focar no código para facilitar a edição
    document.getElementById("codigo").focus();
  });

  // Função para bloquear campos fixos após preenchimento
  function bloquearCamposFixos() {
    const centroCusto = document.getElementById("inputCentroCusto");
    const solicitante = document.getElementById("inputSolicitante");
    const responsavel = document.getElementById("inputResponsavel");

    // Se algum desses estiver vazio, deixa editável para preencher pela primeira vez
    if (centroCusto.value.trim() && solicitante.value.trim() && responsavel.value.trim()) {
      centroCusto.readOnly = true;
      solicitante.readOnly = true;
      responsavel.readOnly = true;
      centroCusto.style.backgroundColor = "#eee";
      solicitante.style.backgroundColor = "#eee";
      responsavel.style.backgroundColor = "#eee";
    } else {
      centroCusto.readOnly = false;
      solicitante.readOnly = false;
      responsavel.readOnly = false;
      centroCusto.style.backgroundColor = "white";
      solicitante.style.backgroundColor = "white";
      responsavel.style.backgroundColor = "white";
    }
  }

  // Pode adicionar um listener para o botão finalizar, se quiser
  document.getElementById("finalizarBtn").addEventListener("click", () => {
    if (carrinho.length === 0) {
      alert("Adicione pelo menos um item antes de finalizar.");
      return;
    }
    // Aqui você pode coletar os dados e enviar pra onde precisar
    alert("Entrega finalizada!");
    // Reset tudo
    carrinho = [];
    renderizarCarrinho();
    limparCamposItem();
    document.getElementById("finalizar").style.display = "none";

    // Liberar campos fixos para próxima entrega
    document.getElementById("inputCentroCusto").readOnly = false;
    document.getElementById("inputSolicitante").readOnly = false;
    document.getElementById("inputResponsavel").readOnly = false;
    document.getElementById("inputCentroCusto").style.backgroundColor = "white";
    document.getElementById("inputSolicitante").style.backgroundColor = "white";
    document.getElementById("inputResponsavel").style.backgroundColor = "white";

    // Limpar campos fixos e transação
    document.getElementById("inputCentroCusto").value = "";
    document.getElementById("inputSolicitante").value = "";
    document.getElementById("inputResponsavel").value = "";
    document.getElementById("inputTransacao").value = "";
  });

</script>
