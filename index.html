<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Entrega de Materiais</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .linha {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    .linha input {
      flex: 1;
    }
    .linha button {
      padding: 10px;
      font-size: 18px;
      border-radius: 5px;
      border: none;
      background-color: #ccc;
      color: #000;
    }
    .quantidade-control {
      display: flex;
      gap: 5px;
      align-items: center;
      margin-top: 5px;
    }
    .quantidade-control button {
      width: 30px;
      height: 30px;
      font-size: 20px;
      border-radius: 5px;
      border: none;
      background-color: #eee;
    }
    .carrinho {
      margin-top: 20px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    .carrinho-item {
      background: #fff;
      padding: 10px;
      margin-bottom: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      position: relative;
    }
    .carrinho-item button {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
    .finalizar {
      margin-top: 20px;
      background: #fff;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      display: none;
    }
    .finalizar input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .btn-principal {
      background-color: #4CAF50;
      color: white;
      font-size: 16px;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 5px;
      margin-top: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>Entrega de Materiais</h1>

  <label>C√≥digo de barras ou manual:</label>
  <div class="linha">
    <input type="text" id="codigo" placeholder="C√≥digo de barras" onblur="buscarDescricao()">
    <button disabled>üì∑</button>
  </div>

  <label>Descri√ß√£o:</label>
  <input type="text" id="descricao" placeholder="Descri√ß√£o do produto" readonly>

  <label>Quantidade:</label>
  <div class="quantidade-control">
    <button onclick="alterarQuantidade(-1)">‚àí</button>
    <input type="number" id="quantidade" value="1" min="1">
    <button onclick="alterarQuantidade(1)">+</button>
  </div>

  <button class="btn-principal" onclick="adicionarItem()">Adicionar ao carrinho</button>
  <button class="btn-principal" id="editarUltimoBtn" style="display:none;">Editar √öltimo Item</button>

  <div class="carrinho" id="carrinho">
    <h3>Itens adicionados:</h3>
  </div>

  <div class="finalizar" id="finalizar">
    <label>Transa√ß√£o (3 caracteres):</label>
    <input type="text" maxlength="3" id="inputTransacao">

    <label>Centro de Custo (6 caracteres):</label>
    <input type="text" maxlength="6" id="inputCentroCusto">

    <label>Solicitante:</label>
    <input type="text" id="inputSolicitante">

    <label>Respons√°vel pelo Atendimento:</label>
    <input type="text" id="inputResponsavel">

    <button class="btn-principal" id="finalizarBtn">Finalizar Entrega</button>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzrUd51_l3if4GdFaVHYtxvYfznpHH5TN16GgB9yFZHQwNYOE30QKJTuawEtQa914hm/exec";

    let carrinho = [];
    let editandoIndex = -1;
    let ultimoCentroCusto = "";

    function alterarQuantidade(valor) {
      const campo = document.getElementById("quantidade");
      let atual = parseInt(campo.value) || 1;
      atual = Math.max(1, atual + valor);
      campo.value = atual;
    }

    async function buscarDescricao() {
      const codigo = document.getElementById("codigo").value.trim();
      if (!codigo) return;

      try {
        const res = await fetch(`${API_URL}?codigo=${codigo}`);
        const json = await res.json();
        if (json.descricao) {
          document.getElementById("descricao").value = json.descricao;
        } else {
          document.getElementById("descricao").value = "Produto n√£o encontrado";
        }
      } catch (e) {
        document.getElementById("descricao").value = "Erro na busca";
      }
    }

    function renderizarCarrinho() {
      const carrinhoDiv = document.getElementById("carrinho");
      carrinhoDiv.innerHTML = "<h3>Itens adicionados:</h3>";
      carrinho.forEach((item, i) => {
        const div = document.createElement("div");
        div.className = "carrinho-item";
        div.innerHTML = `
          C√≥digo: ${item.codigo} | Descri√ß√£o: ${item.descricao} | Quantidade: ${item.quantidade}
          <button onclick="excluirItem(${i})">üóëÔ∏è</button>
        `;
        carrinhoDiv.appendChild(div);
      });

      document.getElementById("editarUltimoBtn").style.display = carrinho.length > 0 ? "block" : "none";
      document.getElementById("finalizar").style.display = carrinho.length > 0 ? "block" : "none";
    }

    function adicionarItem() {
      const codigo = document.getElementById("codigo").value.trim();
      const descricao = document.getElementById("descricao").value.trim();
      const quantidade = parseInt(document.getElementById("quantidade").value);

      if (!codigo || !descricao || !quantidade || descricao === "Produto n√£o encontrado") {
        alert("Preencha um c√≥digo v√°lido e aguarde a descri√ß√£o.");
        return;
      }

      if (editandoIndex >= 0) {
        carrinho[editandoIndex] = { codigo, descricao, quantidade };
        editandoIndex = -1;
      } else {
        carrinho.push({ codigo, descricao, quantidade });
      }

      renderizarCarrinho();
      bloquearCamposFixos();
      limparCamposItem();
      restaurarCentroCusto();
    }

    function excluirItem(index) {
      carrinho.splice(index, 1);
      renderizarCarrinho();
    }

    function limparCamposItem() {
      document.getElementById("codigo").value = "";
      document.getElementById("descricao").value = "";
      document.getElementById("quantidade").value = 1;
    }

    function restaurarCentroCusto() {
      if (ultimoCentroCusto) {
        document.getElementById("inputCentroCusto").value = ultimoCentroCusto;
      }
    }

    function bloquearCamposFixos() {
      const cc = document.getElementById("inputCentroCusto");
      const sol = document.getElementById("inputSolicitante");
      const resp = document.getElementById("inputResponsavel");

      if (sol.value.trim() && resp.value.trim()) {
        sol.readOnly = true;
        resp.readOnly = true;
        sol.style.backgroundColor = "#eee";
        resp.style.backgroundColor = "#eee";
      }

      if (cc.value.trim()) {
        ultimoCentroCusto = cc.value.trim();
      }
    }

    document.getElementById("editarUltimoBtn").addEventListener("click", () => {
      if (carrinho.length === 0) return;
      editandoIndex = carrinho.length - 1;
      const item = carrinho[editandoIndex];
      document.getElementById("codigo").value = item.codigo;
      document.getElementById("descricao").value = item.descricao;
      document.getElementById("quantidade").value = item.quantidade;
      document.getElementById("codigo").focus();
    });

    document.getElementById("finalizarBtn").addEventListener("click", () => {
      if (carrinho.length === 0) {
        alert("Adicione pelo menos um item antes de finalizar.");
        return;
      }

      alert("Entrega finalizada!");
      carrinho = [];
      renderizarCarrinho();
      limparCamposItem();

      document.getElementById("finalizar").style.display = "none";

      ["inputCentroCusto", "inputSolicitante", "inputResponsavel"].forEach(id => {
        const el = document.getElementById(id);
        el.readOnly = false;
        el.style.backgroundColor = "white";
        el.value = "";
      });

      document.getElementById("inputTransacao").value = "";
      ultimoCentroCusto = "";
    });
  </script>
</body>
</html>
