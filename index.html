<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Entrega de Materiais</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --cor-bg: linear-gradient(135deg, #20dbc3, #001c97);
      --btn-bg: linear-gradient(135deg, #c0a677, #f7f3e6);
      --text-color: white;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--cor-bg);
      color: var(--text-color);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tabs button {
      background: var(--btn-bg);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      color: black;
    }
    .tabs button.active {
      background: white;
      color: #001c97;
    }
    .aba {
      display: none;
      width: 100%;
      max-width: 600px;
    }
    .aba.active {
      display: block;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      margin-bottom: 10px;
    }
    .linha {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .linha button {
      font-size: 24px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: var(--btn-bg);
      cursor: pointer;
      color: black;
    }
    .quantidade-control {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .quantidade-control button {
      width: 40px;
      height: 40px;
      font-size: 20px;
      background: var(--btn-bg);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: black;
    }
    .btn-principal {
      margin-top: 10px;
      padding: 12px;
      width: 100%;
      font-size: 16px;
      font-weight: bold;
      background: var(--btn-bg);
      border: none;
      border-radius: 8px;
      color: black;
      cursor: pointer;
    }
    .carrinho {
      background: white;
      color: black;
      padding: 10px;
      margin-top: 20px;
      border-radius: 8px;
    }
    .item {
      background: #eee;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 8px;
      position: relative;
    }
    .acoes {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 5px;
    }
    .acoes button {
      padding: 5px 8px;
      font-size: 12px;
      border: none;
      border-radius: 5px;
      color: white;
    }
    .acoes .editar { background-color: #007bff; }
    .acoes .excluir { background-color: #dc3545; }
    #leitor-camera, #leitor-camera-transferencia {
      display: none;
      margin-top: 10px;
      position: relative;
    }
    .fechar-camera-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255, 0, 0, 0.8);
      border: none;
      color: white;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 10;
    }
  </style>
</head>
<body>

  <h1>Entrega de Materiais</h1>
  <div class="tabs">
    <button id="btn-uso" class="active" onclick="mostrarAba('uso')">Uso Consumo</button>
    <button id="btn-transferencia" onclick="mostrarAba('transferencia')">TransferÃªncia</button>
  </div>

  <div id="aba-uso" class="aba active">
    <label>TransaÃ§Ã£o</label><input id="transacao" />
    <label>Centro de Custo</label><input id="centro" />
    <label>Solicitante</label><input id="solicitante" />
    <label>ResponsÃ¡vel</label><input id="responsavel" />
    <label>CÃ³digo</label>
    <div class="linha">
      <input id="codigo" />
      <button onclick="iniciarScanner('codigo', 'leitor-camera')">ðŸ“·</button>
    </div>
    <div id="leitor-camera"><button class="fechar-camera-btn" onclick="fecharScanner('leitor-camera')">X</button></div>
    <label>Quantidade</label>
    <div class="quantidade-control">
      <button onclick="alterarQtd('quantidade', -1)">-</button>
      <input type="number" id="quantidade" value="1" />
      <button onclick="alterarQtd('quantidade', 1)">+</button>
    </div>
    <button class="btn-principal" onclick="adicionarItemUso()">Adicionar</button>
    <div class="carrinho" id="carrinhoUso"></div>
    <button class="btn-principal" onclick="exportarUso()">Finalizar Entrega</button>
  </div>

  <div id="aba-transferencia" class="aba">
    <label>Origem</label><input id="origem" />
    <label>Destino</label><input id="destino" />
    <label>Solicitante</label><input id="solicitanteT" />
    <label>ResponsÃ¡vel</label><input id="responsavelT" />
    <label>CÃ³digo</label>
    <div class="linha">
      <input id="codigoT" />
      <button onclick="iniciarScanner('codigoT', 'leitor-camera-transferencia')">ðŸ“·</button>
    </div>
    <div id="leitor-camera-transferencia"><button class="fechar-camera-btn" onclick="fecharScanner('leitor-camera-transferencia')">X</button></div>
    <label>Quantidade</label>
    <div class="quantidade-control">
      <button onclick="alterarQtd('quantidadeT', -1)">-</button>
      <input type="number" id="quantidadeT" value="1" />
      <button onclick="alterarQtd('quantidadeT', 1)">+</button>
    </div>
    <button class="btn-principal" onclick="adicionarItemTransf()">Adicionar</button>
    <div class="carrinho" id="carrinhoTransf"></div>
    <button class="btn-principal" onclick="exportarTransf()">Finalizar TransferÃªncia</button>
  </div>

<script>
let carrinhoUso = [], carrinhoTransf = [], scanner;

function mostrarAba(aba) {
  document.querySelectorAll(".aba").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(el => el.classList.remove("active"));
  document.getElementById("aba-" + aba).classList.add("active");
  document.getElementById("btn-" + aba).classList.add("active");
}

function alterarQtd(id, delta) {
  const el = document.getElementById(id);
  el.value = Math.max(1, parseInt(el.value || 1) + delta);
}

function adicionarItemUso() {
  const item = {
    transacao: transacao.value,
    centro: centro.value,
    solicitante: solicitante.value,
    responsavel: responsavel.value,
    codigo: codigo.value,
    quantidade: quantidade.value
  };
  if (Object.values(item).some(v => !v)) return alert("Preencha todos os campos.");
  carrinhoUso.push(item);
  renderCarrinho(carrinhoUso, "carrinhoUso", "uso");
  codigo.value = ""; quantidade.value = 1;
}

function adicionarItemTransf() {
  const item = {
    origem: origem.value,
    destino: destino.value,
    solicitante: solicitanteT.value,
    responsavel: responsavelT.value,
    codigo: codigoT.value,
    quantidade: quantidadeT.value
  };
  if (Object.values(item).some(v => !v)) return alert("Preencha todos os campos.");
  carrinhoTransf.push(item);
  renderCarrinho(carrinhoTransf, "carrinhoTransf", "transf");
  codigoT.value = ""; quantidadeT.value = 1;
}

function renderCarrinho(carrinho, id, tipo) {
  const div = document.getElementById(id);
  div.innerHTML = "";
  carrinho.forEach((item, i) => {
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <div><b>${item.codigo}</b> (${item.quantidade})</div>
      <div class="acoes">
        <button class="editar" onclick="editarItem('${tipo}', ${i})">Editar</button>
        <button class="excluir" onclick="excluirItem('${tipo}', ${i})">Excluir</button>
      </div>`;
    div.appendChild(el);
  });
}

function editarItem(tipo, i) {
  const item = tipo === "uso" ? carrinhoUso[i] : carrinhoTransf[i];
  if (tipo === "uso") {
    transacao.value = item.transacao;
    centro.value = item.centro;
    solicitante.value = item.solicitante;
    responsavel.value = item.responsavel;
    codigo.value = item.codigo;
    quantidade.value = item.quantidade;
    carrinhoUso.splice(i, 1);
    renderCarrinho(carrinhoUso, "carrinhoUso", "uso");
  } else {
    origem.value = item.origem;
    destino.value = item.destino;
    solicitanteT.value = item.solicitante;
    responsavelT.value = item.responsavel;
    codigoT.value = item.codigo;
    quantidadeT.value = item.quantidade;
    carrinhoTransf.splice(i, 1);
    renderCarrinho(carrinhoTransf, "carrinhoTransf", "transf");
  }
}

function excluirItem(tipo, i) {
  if (tipo === "uso") {
    carrinhoUso.splice(i, 1);
    renderCarrinho(carrinhoUso, "carrinhoUso", "uso");
  } else {
    carrinhoTransf.splice(i, 1);
    renderCarrinho(carrinhoTransf, "carrinhoTransf", "transf");
  }
}

function exportarUso() {
  if (carrinhoUso.length === 0) return alert("Adicione itens primeiro.");
  const ws = XLSX.utils.json_to_sheet(carrinhoUso);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "UsoConsumo");
  XLSX.writeFile(wb, "UsoConsumo.xlsx");
  carrinhoUso = [];
  renderCarrinho(carrinhoUso, "carrinhoUso", "uso");
}

function exportarTransf() {
  if (carrinhoTransf.length === 0) return alert("Adicione itens primeiro.");
  const ws = XLSX.utils.json_to_sheet(carrinhoTransf);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Transferencia");
  XLSX.writeFile(wb, "Transferencia.xlsx");
  carrinhoTransf = [];
  renderCarrinho(carrinhoTransf, "carrinhoTransf", "transf");
}

function iniciarScanner(campoId, leitorId) {
  const leitor = document.getElementById(leitorId);
  leitor.style.display = "block";
  if (scanner) scanner.clear().catch(() => {});
  scanner = new Html5Qrcode(leitorId);
  Html5Qrcode.getCameras().then(cameras => {
    const cam = cameras.find(c => c.label.toLowerCase().includes("back")) || cameras[0];
    scanner.start(cam.id, { fps: 10, qrbox: 250 }, txt => {
      document.getElementById(campoId).value = txt;
      fecharScanner(leitorId);
    });
  });
}

function fecharScanner(leitorId) {
  const leitor = document.getElementById(leitorId);
  leitor.style.display = "none";
  if (scanner) {
    scanner.stop().then(() => scanner.clear()).catch(() => {});
    scanner = null;
  }
}
</script>
</body>
</html>
